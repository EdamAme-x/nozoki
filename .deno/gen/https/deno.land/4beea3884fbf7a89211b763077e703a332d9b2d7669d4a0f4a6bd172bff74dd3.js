const LABEL_REG_EXP_STR = '[^/]+';
const ONLY_WILDCARD_REG_EXP_STR = '.*';
const TAIL_WILDCARD_REG_EXP_STR = '(?:|/.*)';
export const PATH_ERROR = Symbol();
/**
 * Sort order:
 * 1. literal
 * 2. special pattern (e.g. :label{[0-9]+})
 * 3. common label pattern (e.g. :label)
 * 4. wildcard
 */ function compareKey(a, b) {
    if (a.length === 1) {
        return b.length === 1 ? a < b ? -1 : 1 : -1;
    }
    if (b.length === 1) {
        return 1;
    }
    // wildcard
    if (a === ONLY_WILDCARD_REG_EXP_STR || a === TAIL_WILDCARD_REG_EXP_STR) {
        return 1;
    } else if (b === ONLY_WILDCARD_REG_EXP_STR || b === TAIL_WILDCARD_REG_EXP_STR) {
        return -1;
    }
    // label
    if (a === LABEL_REG_EXP_STR) {
        return 1;
    } else if (b === LABEL_REG_EXP_STR) {
        return -1;
    }
    return a.length === b.length ? a < b ? -1 : 1 : b.length - a.length;
}
export class Node {
    index;
    varIndex;
    children = {};
    insert(tokens, index, paramMap, context, pathErrorCheckOnly) {
        if (tokens.length === 0) {
            if (this.index !== undefined) {
                throw PATH_ERROR;
            }
            if (pathErrorCheckOnly) {
                return;
            }
            this.index = index;
            return;
        }
        const [token, ...restTokens] = tokens;
        const pattern = token === '*' ? restTokens.length === 0 ? [
            '',
            '',
            ONLY_WILDCARD_REG_EXP_STR
        ] // '*' matches to all the trailing paths
         : [
            '',
            '',
            LABEL_REG_EXP_STR
        ] : token === '/*' ? [
            '',
            '',
            TAIL_WILDCARD_REG_EXP_STR
        ] // '/path/to/*' is /\/path\/to(?:|/.*)$
         : token.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);
        let node;
        if (pattern) {
            const name = pattern[1];
            const regexpStr = pattern[2] || LABEL_REG_EXP_STR;
            node = this.children[regexpStr];
            if (!node) {
                if (Object.keys(this.children).some((k)=>k !== ONLY_WILDCARD_REG_EXP_STR && k !== TAIL_WILDCARD_REG_EXP_STR)) {
                    throw PATH_ERROR;
                }
                if (pathErrorCheckOnly) {
                    return;
                }
                node = this.children[regexpStr] = new Node();
                if (name !== '') {
                    node.varIndex = context.varIndex++;
                }
            }
            if (!pathErrorCheckOnly && name !== '') {
                if (paramMap.some((p)=>p[0] === name)) {
                    throw new Error('Duplicate param name');
                }
                paramMap.push([
                    name,
                    node.varIndex
                ]);
            }
        } else {
            node = this.children[token];
            if (!node) {
                if (Object.keys(this.children).some((k)=>k.length > 1 && k !== ONLY_WILDCARD_REG_EXP_STR && k !== TAIL_WILDCARD_REG_EXP_STR)) {
                    throw PATH_ERROR;
                }
                if (pathErrorCheckOnly) {
                    return;
                }
                node = this.children[token] = new Node();
            }
        }
        node.insert(restTokens, index, paramMap, context, pathErrorCheckOnly);
    }
    buildRegExpStr() {
        const childKeys = Object.keys(this.children).sort(compareKey);
        const strList = childKeys.map((k)=>{
            const c = this.children[k];
            return (typeof c.varIndex === 'number' ? `(${k})@${c.varIndex}` : k) + c.buildRegExpStr();
        });
        if (typeof this.index === 'number') {
            strList.unshift(`#${this.index}`);
        }
        if (strList.length === 0) {
            return '';
        }
        if (strList.length === 1) {
            return strList[0];
        }
        return '(?:' + strList.join('|') + ')';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvaG9ub0B2My40LjEvcm91dGVyL3JlZy1leHAtcm91dGVyL25vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgTEFCRUxfUkVHX0VYUF9TVFIgPSAnW14vXSsnXG5jb25zdCBPTkxZX1dJTERDQVJEX1JFR19FWFBfU1RSID0gJy4qJ1xuY29uc3QgVEFJTF9XSUxEQ0FSRF9SRUdfRVhQX1NUUiA9ICcoPzp8Ly4qKSdcbmV4cG9ydCBjb25zdCBQQVRIX0VSUk9SID0gU3ltYm9sKClcblxuZXhwb3J0IHR5cGUgUGFyYW1NYXAgPSBBcnJheTxbc3RyaW5nLCBudW1iZXJdPlxuZXhwb3J0IGludGVyZmFjZSBDb250ZXh0IHtcbiAgdmFySW5kZXg6IG51bWJlclxufVxuXG4vKipcbiAqIFNvcnQgb3JkZXI6XG4gKiAxLiBsaXRlcmFsXG4gKiAyLiBzcGVjaWFsIHBhdHRlcm4gKGUuZy4gOmxhYmVse1swLTldK30pXG4gKiAzLiBjb21tb24gbGFiZWwgcGF0dGVybiAoZS5nLiA6bGFiZWwpXG4gKiA0LiB3aWxkY2FyZFxuICovXG5mdW5jdGlvbiBjb21wYXJlS2V5KGE6IHN0cmluZywgYjogc3RyaW5nKTogbnVtYmVyIHtcbiAgaWYgKGEubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIGIubGVuZ3RoID09PSAxID8gKGEgPCBiID8gLTEgOiAxKSA6IC0xXG4gIH1cbiAgaWYgKGIubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIDFcbiAgfVxuXG4gIC8vIHdpbGRjYXJkXG4gIGlmIChhID09PSBPTkxZX1dJTERDQVJEX1JFR19FWFBfU1RSIHx8IGEgPT09IFRBSUxfV0lMRENBUkRfUkVHX0VYUF9TVFIpIHtcbiAgICByZXR1cm4gMVxuICB9IGVsc2UgaWYgKGIgPT09IE9OTFlfV0lMRENBUkRfUkVHX0VYUF9TVFIgfHwgYiA9PT0gVEFJTF9XSUxEQ0FSRF9SRUdfRVhQX1NUUikge1xuICAgIHJldHVybiAtMVxuICB9XG5cbiAgLy8gbGFiZWxcbiAgaWYgKGEgPT09IExBQkVMX1JFR19FWFBfU1RSKSB7XG4gICAgcmV0dXJuIDFcbiAgfSBlbHNlIGlmIChiID09PSBMQUJFTF9SRUdfRVhQX1NUUikge1xuICAgIHJldHVybiAtMVxuICB9XG5cbiAgcmV0dXJuIGEubGVuZ3RoID09PSBiLmxlbmd0aCA/IChhIDwgYiA/IC0xIDogMSkgOiBiLmxlbmd0aCAtIGEubGVuZ3RoXG59XG5cbmV4cG9ydCBjbGFzcyBOb2RlIHtcbiAgaW5kZXg/OiBudW1iZXJcbiAgdmFySW5kZXg/OiBudW1iZXJcbiAgY2hpbGRyZW46IFJlY29yZDxzdHJpbmcsIE5vZGU+ID0ge31cblxuICBpbnNlcnQoXG4gICAgdG9rZW5zOiByZWFkb25seSBzdHJpbmdbXSxcbiAgICBpbmRleDogbnVtYmVyLFxuICAgIHBhcmFtTWFwOiBQYXJhbU1hcCxcbiAgICBjb250ZXh0OiBDb250ZXh0LFxuICAgIHBhdGhFcnJvckNoZWNrT25seTogYm9vbGVhblxuICApOiB2b2lkIHtcbiAgICBpZiAodG9rZW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgaWYgKHRoaXMuaW5kZXggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBQQVRIX0VSUk9SXG4gICAgICB9XG4gICAgICBpZiAocGF0aEVycm9yQ2hlY2tPbmx5KSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICB0aGlzLmluZGV4ID0gaW5kZXhcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IFt0b2tlbiwgLi4ucmVzdFRva2Vuc10gPSB0b2tlbnNcbiAgICBjb25zdCBwYXR0ZXJuID1cbiAgICAgIHRva2VuID09PSAnKidcbiAgICAgICAgPyByZXN0VG9rZW5zLmxlbmd0aCA9PT0gMFxuICAgICAgICAgID8gWycnLCAnJywgT05MWV9XSUxEQ0FSRF9SRUdfRVhQX1NUUl0gLy8gJyonIG1hdGNoZXMgdG8gYWxsIHRoZSB0cmFpbGluZyBwYXRoc1xuICAgICAgICAgIDogWycnLCAnJywgTEFCRUxfUkVHX0VYUF9TVFJdXG4gICAgICAgIDogdG9rZW4gPT09ICcvKidcbiAgICAgICAgPyBbJycsICcnLCBUQUlMX1dJTERDQVJEX1JFR19FWFBfU1RSXSAvLyAnL3BhdGgvdG8vKicgaXMgL1xcL3BhdGhcXC90byg/OnwvLiopJFxuICAgICAgICA6IHRva2VuLm1hdGNoKC9eXFw6KFteXFx7XFx9XSspKD86XFx7KC4rKVxcfSk/JC8pXG5cbiAgICBsZXQgbm9kZVxuICAgIGlmIChwYXR0ZXJuKSB7XG4gICAgICBjb25zdCBuYW1lID0gcGF0dGVyblsxXVxuICAgICAgY29uc3QgcmVnZXhwU3RyID0gcGF0dGVyblsyXSB8fCBMQUJFTF9SRUdfRVhQX1NUUlxuXG4gICAgICBub2RlID0gdGhpcy5jaGlsZHJlbltyZWdleHBTdHJdXG4gICAgICBpZiAoIW5vZGUpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMuY2hpbGRyZW4pLnNvbWUoXG4gICAgICAgICAgICAoaykgPT4gayAhPT0gT05MWV9XSUxEQ0FSRF9SRUdfRVhQX1NUUiAmJiBrICE9PSBUQUlMX1dJTERDQVJEX1JFR19FWFBfU1RSXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBQQVRIX0VSUk9SXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBhdGhFcnJvckNoZWNrT25seSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIG5vZGUgPSB0aGlzLmNoaWxkcmVuW3JlZ2V4cFN0cl0gPSBuZXcgTm9kZSgpXG4gICAgICAgIGlmIChuYW1lICE9PSAnJykge1xuICAgICAgICAgIG5vZGUudmFySW5kZXggPSBjb250ZXh0LnZhckluZGV4KytcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFwYXRoRXJyb3JDaGVja09ubHkgJiYgbmFtZSAhPT0gJycpIHtcbiAgICAgICAgaWYgKHBhcmFtTWFwLnNvbWUoKHApID0+IHBbMF0gPT09IG5hbWUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEdXBsaWNhdGUgcGFyYW0gbmFtZScpXG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1NYXAucHVzaChbbmFtZSwgbm9kZS52YXJJbmRleCBhcyBudW1iZXJdKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBub2RlID0gdGhpcy5jaGlsZHJlblt0b2tlbl1cbiAgICAgIGlmICghbm9kZSkge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgT2JqZWN0LmtleXModGhpcy5jaGlsZHJlbikuc29tZShcbiAgICAgICAgICAgIChrKSA9PlxuICAgICAgICAgICAgICBrLmxlbmd0aCA+IDEgJiYgayAhPT0gT05MWV9XSUxEQ0FSRF9SRUdfRVhQX1NUUiAmJiBrICE9PSBUQUlMX1dJTERDQVJEX1JFR19FWFBfU1RSXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBQQVRIX0VSUk9SXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBhdGhFcnJvckNoZWNrT25seSkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIG5vZGUgPSB0aGlzLmNoaWxkcmVuW3Rva2VuXSA9IG5ldyBOb2RlKClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBub2RlLmluc2VydChyZXN0VG9rZW5zLCBpbmRleCwgcGFyYW1NYXAsIGNvbnRleHQsIHBhdGhFcnJvckNoZWNrT25seSlcbiAgfVxuXG4gIGJ1aWxkUmVnRXhwU3RyKCk6IHN0cmluZyB7XG4gICAgY29uc3QgY2hpbGRLZXlzID0gT2JqZWN0LmtleXModGhpcy5jaGlsZHJlbikuc29ydChjb21wYXJlS2V5KVxuXG4gICAgY29uc3Qgc3RyTGlzdCA9IGNoaWxkS2V5cy5tYXAoKGspID0+IHtcbiAgICAgIGNvbnN0IGMgPSB0aGlzLmNoaWxkcmVuW2tdXG4gICAgICByZXR1cm4gKHR5cGVvZiBjLnZhckluZGV4ID09PSAnbnVtYmVyJyA/IGAoJHtrfSlAJHtjLnZhckluZGV4fWAgOiBrKSArIGMuYnVpbGRSZWdFeHBTdHIoKVxuICAgIH0pXG5cbiAgICBpZiAodHlwZW9mIHRoaXMuaW5kZXggPT09ICdudW1iZXInKSB7XG4gICAgICBzdHJMaXN0LnVuc2hpZnQoYCMke3RoaXMuaW5kZXh9YClcbiAgICB9XG5cbiAgICBpZiAoc3RyTGlzdC5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiAnJ1xuICAgIH1cbiAgICBpZiAoc3RyTGlzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJldHVybiBzdHJMaXN0WzBdXG4gICAgfVxuXG4gICAgcmV0dXJuICcoPzonICsgc3RyTGlzdC5qb2luKCd8JykgKyAnKSdcbiAgfVxufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sb0JBQW9CO0FBQzFCLE1BQU0sNEJBQTRCO0FBQ2xDLE1BQU0sNEJBQTRCO0FBQ2xDLE9BQU8sTUFBTSxhQUFhLFNBQVE7QUFPbEM7Ozs7OztDQU1DLEdBQ0QsU0FBUyxXQUFXLENBQVMsRUFBRSxDQUFTLEVBQVU7SUFDaEQsSUFBSSxFQUFFLE1BQU0sS0FBSyxHQUFHO1FBQ2xCLE9BQU8sRUFBRSxNQUFNLEtBQUssSUFBSyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBSSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUNELElBQUksRUFBRSxNQUFNLEtBQUssR0FBRztRQUNsQixPQUFPO0lBQ1QsQ0FBQztJQUVELFdBQVc7SUFDWCxJQUFJLE1BQU0sNkJBQTZCLE1BQU0sMkJBQTJCO1FBQ3RFLE9BQU87SUFDVCxPQUFPLElBQUksTUFBTSw2QkFBNkIsTUFBTSwyQkFBMkI7UUFDN0UsT0FBTyxDQUFDO0lBQ1YsQ0FBQztJQUVELFFBQVE7SUFDUixJQUFJLE1BQU0sbUJBQW1CO1FBQzNCLE9BQU87SUFDVCxPQUFPLElBQUksTUFBTSxtQkFBbUI7UUFDbEMsT0FBTyxDQUFDO0lBQ1YsQ0FBQztJQUVELE9BQU8sRUFBRSxNQUFNLEtBQUssRUFBRSxNQUFNLEdBQUksSUFBSSxJQUFJ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